
<!DOCTYPE html>
<html lang="" class="loading">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>廖锡洪</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate">
    <meta name="keywords" content="viabcde,"> 
    
    <meta name="author" content="viacbde"> 
    <link rel="alternative" href="atom.xml" title="廖锡洪" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <link rel="stylesheet" href="/css/diaspora.css">
</head>
</html>
<body class="loading">
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="icon-home image-icon" href="javascript:;"></a>
    <div title="播放/暂停" class="icon-play"></div>
    <h3 class="subtitle">Mybatis缓存</h3>
    <div class="social">
        <!--<div class="like-icon">-->
            <!--<a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
        <!--</div>-->
        <div>
            <div class="share">
                <a title="获取二维码" class="icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>
    <div class="section">
        <div class="article">
    <div class="main">
        <h1 class="title">Mybatis缓存</h1>
        <div class="stuff">
            <span>十一月 19, 2018</span>
            
  <ul class="post-tags-list"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/Mybatis/">Mybatis</a><span class="post-tags-list-count">18</span></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/标签/">标签</a><span class="post-tags-list-count">162</span></li></ul>


        </div>
        <div class="content markdown">
            <h2 id="Hibernate二级缓存的注意要点"><a href="#Hibernate二级缓存的注意要点" class="headerlink" title="Hibernate二级缓存的注意要点"></a><strong>Hibernate二级缓存的注意要点</strong></h2><h2 id="一级缓存"><a href="#一级缓存" class="headerlink" title="一级缓存"></a><strong>一级缓存</strong></h2><p>是必需的，位于Session（是一个HashMap,存放对象的引用）在 session commit 时 清空一级缓存 (防止其他用户 读取到 修改的脏数据)    </p>
<h2 id="二级缓存"><a href="#二级缓存" class="headerlink" title="二级缓存"></a><strong>二级缓存</strong></h2><p>非必需，跨多个session，由SessionFactory控制<br>二级缓存可指定使用何种Cache工具，Hibernate 3以后的版本默认使用的是Ehcache，也可以切换为Oscache、JbossCache.  </p>
<h2 id="缓存策略："><a href="#缓存策略：" class="headerlink" title="缓存策略："></a><strong>缓存策略：</strong></h2><p>比如最大缓存数、缓存过期时间等，将这些参数降低至一个合理的范围<br>首先判断二级缓存有没有 再判断一级缓存有没有 都没有后 才执行sql语句<br>session 共享一个namespace为Usermapper二级缓存 但不共享 namespace为goodsmapper二级缓存<br>如果要这两个mapper.xml使用相同的namespace那么就共享同一个二级缓存   </p>
<h2 id="开启全部二级缓存"><a href="#开启全部二级缓存" class="headerlink" title="开启全部二级缓存"></a><strong>开启全部二级缓存</strong></h2><p><strong>在sqlmapconfig.xml中</strong><br><img src="https://viabcde.github.io/images/blog/20180928137.png" alt="enter descriptionhere"><br>仅开启一个mapper的二级缓存 usermapper,xml中<br><img src="https://viabcde.github.io/images/blog/20180928138.png" alt="enter descriptionhere">  </p>
<h2 id="整合echache"><a href="#整合echache" class="headerlink" title="整合echache"></a><strong>整合echache</strong></h2><p><strong>加入2个jar包</strong><br><img src="https://viabcde.github.io/images/blog/20180928138_1.png" alt="enter descriptionhere"><br><strong>usermapper.xml中加入</strong><br><img src="https://viabcde.github.io/images/blog/20180928139.png" alt="enter descriptionhere"><br><strong>echache配置文件classpath下</strong><br><img src="https://viabcde.github.io/images/blog/20180928140.png" alt="enter descriptionhere"><br>po实体类 实现序列化接口(因为二级缓存 可能存在硬盘中  当从硬盘中读取需要反序列化读取)<br>只要sqlsession不提交 就不会清空二级缓存  </p>
<h2 id="何时清空二级缓存"><a href="#何时清空二级缓存" class="headerlink" title="何时清空二级缓存"></a><strong>何时清空二级缓存</strong></h2><p>请求频繁、对实时数据要求不高的数据 不要求每次都是最新数据  （设置刷新频率久一点 30分钟 24小时）<br>实时性高的 操作后会自动更新缓存 即把缓存清空了  </p>
<h2 id="二级缓存-局限性"><a href="#二级缓存-局限性" class="headerlink" title="二级缓存 局限性"></a><strong>二级缓存 局限性</strong></h2><p>A客户查询 了 a 商品 B客户查询了 b商品 …都存入了二级缓存 （有1w个商品）<br>当有一个更新商品的操作 那么二级缓存全部被清空了 因此可以说mybatis二级缓存只能针对整个mapper 而不是某一种操作设置二级缓存，粒度不够细<br><strong>缓存</strong><br>同hibernate一样，一级缓存（session级）是默认开启的，如果需要开启二级缓存，就需要加以下配置：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 在核心配置文件中加入配置 --&gt;</span><br><span class="line">&lt;setting name=&quot;cacheEnabled&quot; value=&quot;true&quot;/&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 在mapper文件中加入配置 --&gt;</span><br><span class="line">&lt;cache /&gt;</span><br></pre></td></tr></table></figure>
<p><code>&lt;cache /&gt;</code> 语句的效果如下：<br>映射语句文件中的所有 <code>select</code> 语句将会被缓存。<br>映射语句文件中的所有 <code>insert， update 和 delete</code>语句会刷新缓存。<br>缓存会使用 Least Recently Used（ LRU，最近最少使用的）算法来收回。<br>根据时间表（比如 no Flush Interval，没有刷新间隔），缓存不会以任何时间顺序来刷新。<br>缓存会存储列表集合或对象（无论查询方法返回什么）的 1024 个引用。<br>缓存会被视为是 read/write（可读/可写）的缓存，意味着对象检索不是共享的，而且可以安全地被调用者修改，而不干扰其他调用者或线程所做的潜在修改。<br>所有的这些属性都可以通过缓存元素的属性来修改。比如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;cache eviction=&quot;FIFO&quot; flushInterval=&quot;60000&quot; size=&quot;512&quot; readOnly=&quot;true&quot;/&gt;</span><br></pre></td></tr></table></figure></p>
<p>这个配置创建了一个 FIFO 缓存，并每隔 60 秒刷新， 存数结果对象或列表的512 个引用，而且返回的对象是只读的，因此在不同线程中的调用者之间修改它们会导致冲突。<br>可用的收回策略有：<br>LRU – 最近最少使用的：移除最长时间不被使用的对象。<br>FIFO – 先进先出：按对象进入缓存的顺序来移除它们。<br>SOFT – 软引用：移除基于垃圾回收器状态和软引用规则的对象。<br>WEAK – 弱引用：更积极地移除基于垃圾收集器状态和弱引用规则的对象。<br>默认的是 LRU。<br><strong>flushInterval</strong>（刷新间隔）可以被设置为任意的正整数，它们代表一个合理的毫秒形式的时间段。默认不设置，即没有刷新间隔，缓存仅仅调用语句时刷新。<br><strong>size</strong>（引用数目）可以被设置为任意正整数，要记住你缓存的对象数目和你运行环境的可用内存资源数目。默认值是 1024。<br><strong>readOnly</strong>（只读）属性可以被设置为 true 或 false。只读的缓存会给所有调用者返回缓存对象的相同实例,可读写的缓存会返回缓存对象的拷贝（通过序列化）,默认是 false。   </p>
<h2 id="动态sql"><a href="#动态sql" class="headerlink" title="动态sql"></a><strong>动态sql</strong></h2><p><strong>if 和 choose when otherwise</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=”findActiveBlogLike” parameterType=”Blog” resultType=”Blog”&gt;</span><br><span class="line">  SELECT * FROM BLOG WHERE state = „ACTIVE‟</span><br><span class="line">  &lt;choose&gt;</span><br><span class="line">    &lt;when test=”title != null”&gt;</span><br><span class="line">      AND title like #&#123;title&#125;</span><br><span class="line">    &lt;/when&gt;</span><br><span class="line">    &lt;when test=”author != null and author.name != null”&gt;</span><br><span class="line">      AND title like #&#123;author.name&#125;</span><br><span class="line">    &lt;/when&gt;</span><br><span class="line">    &lt;otherwise&gt;</span><br><span class="line">      AND featured = 1</span><br><span class="line">    &lt;/otherwise&gt;</span><br><span class="line">  &lt;/choose&gt;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure></p>
<p>关键字<br><strong>where 和 set</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 取代where关键字，当所有if条件不成立时就不会出现where关键字 --&gt;</span><br><span class="line">&lt;select id=”findActiveBlogLike” parameterType=”Blog” resultType=”Blog”&gt;</span><br><span class="line">  SELECT * FROM BLOG</span><br><span class="line">  &lt;where&gt;</span><br><span class="line">    &lt;if test=”state != null”&gt;</span><br><span class="line">      state = #&#123;state&#125;</span><br><span class="line">    &lt;/if&gt;</span><br><span class="line">    &lt;if test=”title != null”&gt;</span><br><span class="line">      AND title like #&#123;title&#125;</span><br><span class="line">    &lt;/if&gt;</span><br><span class="line">    &lt;if test=”author != null and author.name != null”&gt;</span><br><span class="line">      AND title like #&#123;author.name&#125;</span><br><span class="line">    &lt;/if&gt;</span><br><span class="line">  &lt;/where&gt;</span><br><span class="line">&lt;/select&gt;</span><br><span class="line">&lt;update id=&quot;updateAuthorIfNecessary&quot; parameterType=&quot;domain.blog.Author&quot;&gt;</span><br><span class="line">  update Author</span><br><span class="line">  &lt;set&gt;</span><br><span class="line">    &lt;if test=&quot;username != null&quot;&gt;username=#&#123;username&#125;,&lt;/if&gt;</span><br><span class="line">    &lt;if test=&quot;password != null&quot;&gt;password=#&#123;password&#125;,&lt;/if&gt;</span><br><span class="line">    &lt;if test=&quot;email != null&quot;&gt;email=#&#123;email&#125;,&lt;/if&gt;</span><br><span class="line">    &lt;if test=&quot;bio != null&quot;&gt;bio=#&#123;bio&#125;&lt;/if&gt;</span><br><span class="line">  &lt;/set&gt;</span><br><span class="line">  where id=#&#123;id&#125;</span><br><span class="line">&lt;/update&gt;</span><br></pre></td></tr></table></figure></p>
<p><strong>foreach</strong>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot;selectPostIn&quot; resultType=&quot;domain.blog.Post&quot;&gt;</span><br><span class="line">  SELECT * FROM POST P WHERE ID in</span><br><span class="line">  &lt;foreach item=&quot;item&quot; index=&quot;index&quot; collection=&quot;list&quot; open=&quot;(&quot; separator=&quot;,&quot; close=&quot;)&quot;&gt;</span><br><span class="line">    #&#123;item&#125;</span><br><span class="line">  &lt;/foreach&gt;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="true">
                <source type="audio/mpeg" src="/music/1.mp3">
            </audio>
            
        </div>
        
    <div id="gitalk-container" class="comment link" data-ae="false" data-ci="55316b017b800ec5c0da" data-cs="fbe9f4aafee144a34ec283ca34c833ad6da91507" data-r="talk" data-o="viacbde" data-a="viabcde" data-d="false">查看评论</div>


    </div>
    
        <div class="side">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Hibernate二级缓存的注意要点"><span class="toc-number">1.</span> <span class="toc-text">Hibernate二级缓存的注意要点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一级缓存"><span class="toc-number">2.</span> <span class="toc-text">一级缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二级缓存"><span class="toc-number">3.</span> <span class="toc-text">二级缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#缓存策略："><span class="toc-number">4.</span> <span class="toc-text">缓存策略：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#开启全部二级缓存"><span class="toc-number">5.</span> <span class="toc-text">开启全部二级缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#整合echache"><span class="toc-number">6.</span> <span class="toc-text">整合echache</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#何时清空二级缓存"><span class="toc-number">7.</span> <span class="toc-text">何时清空二级缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二级缓存-局限性"><span class="toc-number">8.</span> <span class="toc-text">二级缓存 局限性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#动态sql"><span class="toc-number">9.</span> <span class="toc-text">动态sql</span></a></li></ol>
        </div>
    
</div>


    </div>
</div>
<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body>
<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/diaspora.js"></script>
<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">
<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>




</html>